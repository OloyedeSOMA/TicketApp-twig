<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Ticket Manager Pro</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">


  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50" x-data="dashboard" x-init="init">

  <!-- HEADER -->
  {% include 'partials/header.html.twig' %}

  <main class="p-4 sm:p-6 space-y-6 max-w-7xl mx-auto" x-show="$store.auth.user">
    <section>
      <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
      <p class="text-sm text-gray-500">Overview of your ticket management system</p>
    </section>

    <!-- STATS -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white p-5 rounded-2xl shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Tickets</p>
            <p class="text-2xl font-bold text-gray-900 mt-1" x-text="stats.total">0</p>
          </div>
          <div class="w-3 h-3 rounded-full bg-indigo-600"></div>
        </div>
      </div>

      <div class="bg-white p-5 rounded-2xl shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Open</p>
            <p class="text-2xl font-bold text-gray-900 mt-1" x-text="stats.open">0</p>
          </div>
          <div class="w-3 h-3 rounded-full bg-green-500"></div>
        </div>
      </div>

      <div class="bg-white p-5 rounded-2xl shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">In Progress</p>
            <p class="text-2xl font-bold text-gray-900 mt-1" x-text="stats.inProgress">0</p>
          </div>
          <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
        </div>
      </div>

      <div class="bg-white p-5 rounded-2xl shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Closed</p>
            <p class="text-2xl font-bold text-gray-900 mt-1" x-text="stats.closed">0</p>
          </div>
          <div class="w-3 h-3 rounded-full bg-gray-400"></div>
        </div>
      </div>
    </section>

    <!-- QUICK ACTIONS -->
    <section class="bg-white p-6 rounded-2xl shadow-sm">
      <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <a href="/tickets" class="flex items-start gap-3 p-4 rounded-xl bg-indigo-50 hover:shadow-sm transition">
          <img src="/assets/icons/ticket.svg" alt="" class="w-6 h-6">
          <div>
            <p class="font-medium text-gray-900">View All Tickets</p>
            <p class="text-sm text-gray-500">Manage and organize your tickets</p>
          </div>
        </a>
        <a href="/tickets" class="flex items-start gap-3 p-4 rounded-xl bg-green-50 hover:shadow-sm transition">
          <img src="/assets/icons/ticket.svg" alt="" class="w-6 h-6">
          <div>
            <p class="font-medium text-gray-900">Create New Ticket</p>
            <p class="text-sm text-gray-500">Start tracking a new issue</p>
          </div>
        </a>
      </div>
    </section>
  </main>

  <!-- AUTH STORE + PROTECTION -->
  <script>
    document.addEventListener('alpine:init', () => {
      // AUTH STORE
      const auth = {
        user: null,

        init() {
          this.checkLogin();
        },

        checkLogin() {
          const session = localStorage.getItem('ticketapp_session');
          if (!session) return this.redirectToLogin();
          
          const { userId } = JSON.parse(session);
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          this.user = users.find(u => u.id === userId);
          
          if (!this.user) return this.redirectToLogin();
        },

        redirectToLogin() {
          const current = window.location.pathname;
          const redirect = current !== '/auth' ? `?redirect=${encodeURIComponent(current)}` : '';
          window.location.href = `/auth?mode=login${redirect}`;
        },

        logout() {
          localStorage.removeItem('ticketapp_session');
          this.redirectToLogin();
        },

        isActive(path) {
          return window.location.pathname === path;
        }
      };

      // Register store
      Alpine.store('auth', auth);

      // DASHBOARD LOGIC
      Alpine.data('dashboard', () => ({
        tickets: [],
        stats: { total: 0, open: 0, inProgress: 0, closed: 0 },

        init() {
          this.$nextTick(() => {
            Alpine.store('auth').init();
            this.loadTickets();
          });
        },

        loadTickets() {
          const data = localStorage.getItem('tickets');
          this.tickets = data ? JSON.parse(data) : [];
          this.updateStats();
        },

        updateStats() {
          this.stats.total = this.tickets.length;
          this.stats.open = this.tickets.filter(t => t.status === 'Open').length;
          this.stats.inProgress = this.tickets.filter(t => t.status === 'In Progress').length;
          this.stats.closed = this.tickets.filter(t => t.status === 'Closed').length;
        }
      }));
    });
  </script>
</body>
</html>